<style lang="less">
page {
  background: url(https://qncdn.playonwechat.com/hepulanShop/fight_group_detail_bg.png);
  background-size: 100%;
  background-repeat: no-repeat;
}

.container {
  width: 606rpx;
  min-height: 500rpx;
  background: #fff;
  border-radius: 30rpx;
  margin: 40rpx auto;
  box-shadow: 0 0 30rpx rgba(0, 0, 0, 0.1);
  padding-top: 68rpx;
  .name {
    font-size: 36rpx;
    text-align: center;
    margin-bottom: 40rpx;
  }
  .tip {
    font-size: 24rpx;
    margin-top: 28rpx;
    text-align: center;
  }
  .time {
    font-size: 53rpx;
    text-align: center;
    margin-bottom: 60rpx;
  }
  .swiper {
    width: 482rpx;
    height: 244rpx;
    margin: 0 auto;
    image {
      width: 100%;
      height: 100%;
      display: block;
    }
  } // 商品信息
  .group_info {
    width: 482rpx;
    margin: 0 auto;
    padding: 20rpx 0;
    .info_top {
      justify-content: space-between;
      .price {
        font-size: 34rpx;
      }
      .info_left {
        flex-direction: column;
        justify-content: flex-start;
        align-items: flex-start;
        margin-left: 20rpx;
        .oldprice {
          font-size: 25rpx;
          text-decoration: line-through;
          line-height: 1;
        }
        .tag {
          color: #fff; // height: 30rpx;
          display: flex;
          view:nth-of-type(1) {
            display: block;
            background: #16382e;
            padding: 4rpx 10rpx;
            font-size: 18rpx;
            border-radius: 50rpx;
            margin-right: 10rpx;
          }
          view:nth-of-type(2) {
            display: inline-block;
            background: #16382e;
            padding: 4rpx 10rpx;
            font-size: 18rpx;
            border-radius: 50rpx;
          }
        }
      }
      .help {
        display: flex;
        font-size: 18rpx;
        align-items: center;
        text {
          display: block;
          width: 20rpx;
          height: 20rpx;
          background-image: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABMAAAATCAMAAABFjsb+AAAAY1BMVEUAAAAWOC4WOC4WOC4WOC4WOC4WOC4WOC4WOC4WOC4WOC4WOC4WOC4WOC4WOC4WOC4WOC4WOC4WOC4WOC4WOC4WOC4WOC4WOC4WOC4WOC4WOC4WOC4WOC4WOC4WOC4WOC4WOC4xGaDPAAAAIXRSTlMA/sMJg+t/FcaPUC346MofEg/mtdQxBZR3YTqsbmtWSySLNhQ/AAAArklEQVQY03VQSQ7CQAyz01m6Q3co6/9fyYRAe0D4EFmRFcfGG5UTTy+uwhfHguxlkJ4sjrY65JRSeSyF+QHKWoYMyKKOwDYCKBjSPI1+PAMILICqFhWIu45cldQVHEsAcwdMVGFJh7zpYLhxSrNrcniB4Z4ECvHgYKupXowM3HRLk+Gj2+6FNu3snvmqswYwX/sv4XF5Avaf5dAg9QrLseedI/a81kvcevnX32/PLz8VBvGyWh/WAAAAAElFTkSuQmCC");
          background-size: 100% 100%;
          margin-right: 12rpx;
        }
      }
    } // 颜色
    .type_box {
      display: flex;
      margin-top: 40rpx;
      .title {
        flex-shrink: 0;
        font-size: 24rpx;
        width: 134rpx;
        margin-right: 10rpx;
        text-align: right;
      }
      .type_view {
        text {
          display: inline-block;
          color: #333;
          width: 100rpx;
          height: 46rpx;
          line-height: 46rpx;
          font-size: 26rpx;
          text-align: center;
          background: #e4f1ee;
          border-radius: 6rpx;
          margin-right: 16rpx;
          margin-bottom: 16rpx;
        }
        text:nth-of-type(3n) {
          margin-right: 0;
        }
        .active {
          background: #16382e;
          color: #fff;
        }
      }
    } // 数量
    .count_box {
      margin-top: 30rpx;
      .title {
        width: 134rpx;
        text-align: right;
      }
      .opation_box {
        display: flex;
        view:nth-of-type(1) {
          font-size: 40rpx;
          width: 40rpx;
          height: 40rpx;
          display: flex; // align-items: center;
          justify-content: center;
          background: #16382e;
          color: #fff;
          line-height: 36rpx;
          border-radius: 4rpx 0 0 4rpx;
        }
        view:nth-of-type(2) {
          width: 60rpx;
          height: 40rpx;
          line-height: 40rpx;
          text-align: center;
          border-top: 1px solid #16382e;
          border-bottom: 1px solid #16382e;
        }
        view:nth-of-type(3) {
          font-size: 40rpx;
          width: 40rpx;
          height: 40rpx;
          display: flex; // align-items: center;
          justify-content: center;
          background: #16382e;
          color: #fff;
          line-height: 36rpx;
          border-radius: 0 4rpx 4rpx 0;
        }
      }
    } // 按钮区
    .btn_box {
      display: flex;
      justify-content: space-between;
      margin-top: 60rpx;
      button:nth-of-type(1) {
        width: 110rpx;
        height: 64rpx;
        font-size: 14rpx;
        align-items: center;
        padding-top: 10rpx;
        background: #deede9;
        border-radius: 6rpx;
        margin: 0;
        // margin-right: 30rpx;
        text {
          display: block;
          width: 28rpx;
          height: 28rpx;
          background: url(https://qncdn.playonwechat.com/hepulanShop/kefu.png);
          background-size: 100% 100%;
          margin: 0 auto;
        }
        view {
          font-size: 14rpx;
          line-height: 1;
        }
      }
      button:nth-of-type(1):after {
        display: none;
      }
      .only_buy {
        width: 160rpx !important;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
      }
      .only_buy,
      .group_buy {
        width: 200rpx;
        height: 64rpx;
        text-align: center;
        background: #deede9;
        border-radius: 6rpx;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        .price {
          font-size: 28rpx;
        }
        .tiip {
          font-size: 28rpx;
        }
      }
    } // 收藏及展示
    .collect_box {
      display: flex;
      justify-content: flex-end;
      margin-top: 20rpx;
      .collect {
        display: flex;
        align-items: cneter;
        font-size: 20rpx;
        margin-right: 10rpx;
        text {
          display: block;
          line-height: 40rpx;
        }
      }
      .collect image {
        display: block;
        width: 40rpx;
        height: 40rpx;
        margin-right: 5rpx;
      }
      .collect1 image {
        width: 30rpx;
        height: 30rpx;
        padding: 8rpx 0;
      }
    } // 商品参数及详情
    .detail {
      .nav {
        display: flex;
        justify-content: space-between;
        margin-top: 100rpx;
        view {
          width: 138rpx;
          height: 38rpx;
          color: #333;
          background: #deede9;
          text-align: center;
          line-height: 38rpx;
          font-size: 22rpx;
          border-radius: 10rpx;
        }
        view.active {
          background: #16382e;
          color: #fff;
        }
      }
      .detail_content {
        width: 482rpx;
        min-height: 100rpx;
        margin-top: 40rpx;
      }
      .detail_content {
        image {
          width: 482rpx;
        }
        text:nth-of-type(1) {
          width: 80rpx;
          display: inline-block;
          text-align: right;
        }
      }
    }
  }
}
</style>

<template>
    <view class="container">
        <view class="name">{{detail.name}}</view>
        <!-- <view class="tip">距离拼团结束时间</view>
        <view class="time">{{detail.endtime}}</view> -->
        <!-- 图片轮播 -->
        <swiper class="swiper" indicator-dots="false" autoplay="false" interval="5000" duration="1000">
              <image src="{{detail.logo}}" class="slide-image" />
        </swiper>
        <!-- 商品信息 -->
        <view class="group_info">
            <view class="info_top flex">
                <view class="top_left flex">
                    <view class="price">￥{{detail.groupPrice/100}}</view>
                    <view class="info_left flex">
                        <view class="oldprice">
                            ￥{{detail.price/100}}
                        </view>
                        <!-- <view class="tag">
                            <view>{{detail.num}}人拼团</view>
                            <view>拼团立省{{detail.save_money}}元</view>
                        </view> -->
                    </view>
                </view>
                <!-- <view class="help" @tap="toRules()">
                    <text></text>规则</view> -->
            </view>
            <!-- 颜色 -->
            <view class="type_box">
                <view class="title">{{detail.option.group}}：</view>
                <view class="type_view">
                    <text wx:for="{{detail.option.options}}" class="{{item.active?'active':''}}" wx:key="index" @tap="changeType({{index}})">{{item.option}}</text>
                </view>
            </view>
            <!-- 数量 -->
            <view class="count_box flex">
                <view class="title">数量：</view>
                <view class="opation_box">
                    <view @tap="cutNum(-1)">-</view>
                    <view>{{goodsNum}}</view>
                    <view @tap="cutNum(1)">+</view>
                </view>
            </view>
            <!-- 购买区 -->
            <view class="btn_box">
                <button open-type="concant">
                    <text></text>
                    <view>找客服</view>
                </button>
                <view class="only_buy">
                    <!-- <view class="price">￥{{detail.price/100}}</view> -->
                    <view class="tiip" @tap="addCart">加入购物车</view>
                </view>
                <view class="group_buy">
                    <!-- <view class="price">￥{{detail.groupPrice/100}}</view> -->
                    <view class="tiip" @tap="onlyBuy">立即购买</view>
                </view>
            </view>
            <!-- 收藏及展示 -->
            <view class="collect_box">
                <view class="collect collect1" @tap="collect">
                    <image wx:if="{{detail.collect=='0'?true:false}}" src="https://qncdn.playonwechat.com/group_collect.png"></image>
                    <image wx:if="{{detail.collect=='0'?false:true}}" src="https://qncdn.playonwechat.com/group_collect_active1.png"></image>
                    <text>收藏</text>
                </view>
                <view class="collect">
                    <image src="https://qncdn.playonwechat.com/hepulanShop/group_hepulan_logo.png"></image>
                    <text>官方店铺认证</text>
                </view>
                <view class="collect">
                    <image src="https://qncdn.playonwechat.com/hepulanShop/group_hepulan_pay.png"></image>
                    <text>交易担保</text>
                </view>
            </view>
            <!-- 商品参数及详情介绍 -->
            <view class="detail">
                <view class="nav">
                    <view wx:for="{{navList}}" class="{{item.active?'active':''}}" wx:key="{{index}}" @tap="changeDetail({{index}})">{{item.text}}</view>
                </view>
                <block>
                    <view class="detail_content" wx:if="{{navList[0].active}}">
                       <image src="{{detail.image}}" mode="widthFix"></image>
                    </view>
                    <view class="detail_content" wx:if="{{navList[1].active}}">
                        <view class="item" wx:for="{{detail.args}}">
                             <text>{{item.name}}:</text><text>{{item.value}}</text>
                        </view>
                    </view>
                </block>
                
            </view>
        </view>
    </view>
</template>

<script>
import wepy from "wepy";
import comm from "../../comm/comm";
import tip from "../../comm/tip";
import wxRequest from "../../comm/wxRequest";
import api from "../../api/api";
export default class extends wepy.page {
  config = {
    navigationBarTitleText: "单独购买",
    navigationBarBackgroundColor: "#16382e",
    navigationBarTextStyle: "#fff"
  };
  data = {
    group_id: 0,
    detail: {},
    goodsNum: 1, //商品数量
    goodsIndex: "", //商品默认选择类型
    navList: [
      {
        text: "商品详情",
        active: true
      },
      {
        text: "商品参数",
        active: false
      }
    ]
  };

  methods = {
    // 选择颜色
    changeType(index, e) {
      //    console.log(index,e)
      let color = this.data.detail.option.options;
      for (var i = 0; i < color.length; i++) {
        color[i].active = false;
      }
      color[index].active = true;
      this.data.detail.option.options = color;
      this.goodsIndex = index+1;
      this.$apply();
    },

    toRules(e) {
      // console.log(getCurrentPages())
      wx.navigateTo({
        url: "../groupRules/groupRules"
      });
    },
    // 收藏
    collect() {
      let that = this;
      comm.wxRequest(
        {
          query: { goods: that.detail.goods, uid: wepy.getStorageSync("uid") }
        },
        api.Collect,
        function(res) {
          console.log(res.data.data.msg);
          if (res.data.status == "1") {
            that.detail.collect = that.detail.collect == "1" ? "0" : 1;
            tip.success(res.data.data.msg);
            that.$apply();
          }
        }
      );
    },
    // 切换商品详情和商品参数
    changeDetail(index) {
      let navList = this.navList;
      for (var i = 0; i < navList.length; i++) {
        navList[i].active = false;
      }
      navList[index].active = true;
    },
    // 或者减商品数量
    cutNum(e) {
      if (e > 0) {
        this.goodsNum += 1;
        this.$apply();
      } else if (e < 0) {
        this.goodsNum = this.goodsNum > 1 ? (this.goodsNum -= 1) : 1;
        this.$apply();
      }
    },
    // 加入购物车
    addCart() {
      let that = this;
      if (!this.goodsIndex) {
        console.log(this.detail.option.group);
        tip.alert("请选择商品" + this.detail.option.group, 1500);
        return false;
      }
      comm.wxRequest(
        {
          query: {
            uid: wx.getStorageSync("uid"),
            goods: this.detail.goods,
            num: this.goodsNum,
            option: {
                option:this.detail.option.group,
                value:this.detail.option.options[this.goodsIndex-1].option
            }
          }
        },
        api.addCart,
        function(res) {
            console.log(res)
            if (res.data.status=='1') {
                tip.success(res.data.data.msg)
            }
        }
      );
    },
    // 立即购买
    onlyBuy(){
       let that = this;
       let goods = [{
          goods:this.detail.goods,
          num:this.goodsNum,
          id:this.detail.id,
          option:{
             option:this.detail.option.group,
             value:this.detail.option.options[this.goodsIndex-1].option
          }
       }]
       comm.wxRequest({query:{goods:goods,uid:wx.getStorageSync('uid')}},api.onlyBuy,function(res){
         console.log(res)
       })
    }
  };

  onLoad(options) {
    console.log(options);
    // this.group_id = options.id;
    this.group_id = "56.119.61.61";
    this.$apply();
  }

  onShow() {
    let that = this;
    console.log(api.apiUrl);
    comm.wxRequest(
      { query: { id: that.group_id, uid: wepy.getStorageSync("uid") } },
      api.groupDetail,
      function(res) {
        console.log(res.data.data);
        let _detail = res.data.data;
        _detail.args = JSON.parse(_detail.args);
        _detail.option = JSON.parse(_detail.option);
        _detail.endTime = comm.dateformat(_detail.endTime);
        _detail.image = `${api.apiUrl}/${_detail.image}`;
        _detail.logo = `${api.apiUrl}/${_detail.logo}`;
        that.detail = _detail;
        that.$apply();
      }
    );

    console.log("show");
  }
}
</script>